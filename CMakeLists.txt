CMAKE_MINIMUM_REQUIRED(VERSION 2.6)
PROJECT(nnstreamer-edge)

OPTION(ENABLE_TEST      "Enable Test case" OFF)
OPTION(ENABLE_DEBUG     "Enable Debug" OFF)

IF (NOT DEFINED VERSION)
    SET(VERSION    0.0.1)
ENDIF()

# Set CFLAGS
SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -Werror")
SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${EXTRA_CFLAGS} -pthread -fPIE -fPIC -g")

IF (ENABLE_DEBUG)
    SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -DDEBUG=1")
ELSE()
    SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -DDEBUG=0")
ENDIF()

# Set as-needed option
SET(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,--as-needed")
SET(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -Wl,--as-needed")

SET(SO_VERSION    ${VERSION})
SET(PREFIX        ${CMAKE_INSTALL_PREFIX})
SET(EXEC_PREFIX   ${PREFIX}/bin)
SET(INCLUDE_INSTALL_DIR "${PREFIX}/include")

SET(SOURCE_DIR    ${CMAKE_CURRENT_SOURCE_DIR}/src)
SET(INCLUDE_DIR   ${CMAKE_CURRENT_SOURCE_DIR}/include)
SET(EDGE_MQTT_SRC_DIR  ${SOURCE_DIR}/libedge-mqtt)

# Check requires packages
SET(REQUIRES_LIST
    paho-mqtt-c
)

INCLUDE(FindPkgConfig)
PKG_CHECK_MODULES(EDGE_REQUIRE_PKGS REQUIRED ${REQUIRES_LIST})

FOREACH(flag ${EDGE__REQUIRE_PKGS_CFLAGS})
    SET(EXTRA_CFLAGS "${EXTRA_CFLAGS} ${flag}")
ENDFOREACH(flag)

ADD_SUBDIRECTORY(src)

IF (ENABLE_TEST)
    SET(TEST_REQUIRES_LIST gtest)
    INCLUDE(FindPkgConfig)
    PKG_CHECK_MODULES(TEST_REQUIRE_PKGS REQUIRED ${TEST_REQUIRES_LIST})
    ADD_SUBDIRECTORY(tests)
ENDIF()

# pkgconfig file
CONFIGURE_FILE(ml-edge-mqtt.pc.in ml-edge-mqtt.pc @ONLY)
INSTALL(FILES ${CMAKE_CURRENT_BINARY_DIR}/ml-edge-mqtt.pc
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/pkgconfig)
